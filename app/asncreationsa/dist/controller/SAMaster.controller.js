sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/m/MessageBox"],function(e,t,s,r){"use strict";return e.extend("sap.fiori.asncreationsa.controller.SAMaster",{onInit:function(){this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRoutePatternMatched(this.onRouteMatched,this);this.filterModel=new sap.ui.model.json.JSONModel;this.listTemp=this.byId("idlistitem").clone();this.DataModel=new sap.ui.model.json.JSONModel;this.DataModel.setSizeLimit(1e7);this.getView().setModel(this.DataModel,"DataModel")},onRouteMatched:function(e){if(e.getParameter("name")!=="SAMaster"){return}var t=this;this.userType=this.getOwnerComponent().getModel().getHeaders().loginType;if(t.userType==="P"){this.getASNData()}else{sap.ui.core.BusyIndicator.show();this.suppData=[];return new Promise((e,t)=>{this.getOwnerComponent().getModel().callFunction("/GetSupplierList",{method:"GET",success:t=>{sap.ui.core.BusyIndicator.hide();this.suppData=t.results;this.openDialog();e()},error:e=>{sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.response.body);r.error(t.error.message.value)}})})}},openDialog(){this.dialog=sap.ui.xmlfragment("sap.fiori.asncreationsa.fragment.Dialog",this);this.dialog.setModel(new t([]),"SupplierModel");this.dialog.getModel("SupplierModel").setSizeLimit(this.suppData.length);this.dialog.getModel("SupplierModel").setData(this.suppData);this.dialog.open()},onApplyPress:function(e){let t=[];const s=sap.ui.getCore().byId("suppList");if(s.getSelectedKey()!==""){t.push(true);s.setValueState("None");sessionStorage.setItem("AddressCodeASNSA",s.getSelectedKey())}else{t.push(false);s.setValueState("Error")}if(t.every(e=>e===true)){e.getSource().getParent().destroy();this.getASNData()}},getASNData:function(){sap.ui.core.BusyIndicator.show();var e=this;var t=sap.ui.core.format.DateFormat.getDateInstance({pattern:"ddMMMyyyy"});this.ASNtodate=new Date;this.ASNfromdate=new Date(this.ASNtodate.getTime()-30*24*3600*1e3);this.ASNtodate=t.format(this.ASNtodate);this.ASNfromdate=t.format(this.ASNfromdate);this.ASNtodate=this.ASNtodate.substring(0,2)+" "+this.ASNtodate.substring(2,5)+" "+this.ASNtodate.substring(5,9);this.ASNfromdate=this.ASNfromdate.substring(0,2)+" "+this.ASNfromdate.substring(2,5)+" "+this.ASNfromdate.substring(5,9);this.unitCode=sessionStorage.getItem("unitCode")||"P01";this.AddressCodeASNSA=sessionStorage.getItem("AddressCodeASNSA")||"AKI-03-01";this.LoggedUser=sessionStorage.getItem("LoggedUser")||"rajeshsehgal@impauto.com";var s=this.getOwnerComponent().getModel();s.read("/GetASNHeaderList",{urlParameters:{AddressCode:this.AddressCodeASNSA,PoNumber:"",ASNNumber:"",ASNFromdate:this.ASNfromdate,ASNTodate:this.ASNtodate,InvoiceStatus:"",MRNStatus:"",ApprovedBy:""},success:function(t){sap.ui.core.BusyIndicator.hide();e.PlantCode=t.results[0].PlantCode;e.ASNStatus=t.results[0].ASNStatus;e.DataModel.setData(t);e.DataModel.refresh();e.routeToDetail()},error:function(e){sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.response.body);r.error(t.error.message.value)}})},routeToDetail:function(){var e=this.byId("masterListId").getItems()[0];this.byId("masterListId").setSelectedItem(e,true);if(e){this.AsnNumber=e.getProperty("title").replace(/\//g,"-");this.router.navTo("SADetail",{AsnNumber:this.AsnNumber,AddressCode:this.AddressCodeASNSA,UnitCode:this.PlantCode,ASNStatus:this.ASNStatus})}else{this.router.navTo("NoData")}},onListItemPress:function(e){var t=e.getParameter("listItem").getBindingContext("DataModel").getProperty();var s=e.getParameter("listItem").getProperty("title").replace(/\//g,"-");this.router.navTo("SADetail",{AsnNumber:s,AddressCode:this.AddressCodeASNSA,UnitCode:t.PlantCode,ASNStatus:t.ASNStatus})},onSearch:function(e){var t=this;if(e.getParameter("refreshButtonPressed")===true){this.getView().byId("masterListId").getBinding("items").refresh(true)}else{sap.ui.core.BusyIndicator.show();var s=e.getParameter("query");var a=this.getOwnerComponent().getModel();a.read("/GetASNHeaderList",{urlParameters:{search:s,AddressCode:this.AddressCodeASNSA,PoNumber:"",ASNNumber:"",ASNFromdate:this.ASNfromdate,ASNTodate:this.ASNtodate,InvoiceStatus:"",MRNStatus:"",ApprovedBy:""},success:function(e){sap.ui.core.BusyIndicator.hide();t.PlantCode=e.results[0].PlantCode;t.DataModel.setData(e);t.DataModel.refresh();t.routeToDetail()},error:function(e){sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.response.body);r.error(t.error.message.value)}})}},onDialogEscapeHandler:function(e){e.reject()},onFilter:function(){if(!this.filterFragment){this.filterFragment=sap.ui.xmlfragment("sap.fiori.asncreationsa.fragment.filterFragment",this);this.filterFragment.setModel(this.filterModel,"filterModel")}this.filterVisibleModel=new sap.ui.model.json.JSONModel({ASNNumber:true,StartDate:true,EndDate:true,Werks:true});this.filterFragment.setModel(this.filterVisibleModel,"FilterVisibleModel");this.filterFragment.open()},onPlantValueHelp:function(){if(!this.PlantF4Frag){this.PlantF4Frag=sap.ui.xmlfragment("sap.fiori.asncreationsa.fragment.PlantFrag",this);this.PlantF4Temp=sap.ui.getCore().byId("plantTempId").clone()}this.PlantF4Frag.setModel(new t(JSON.parse(sessionStorage.getItem("CodeDetails"))),"plantModel");this.getView().addDependent(this.PlantF4Frag);sap.ui.getCore().byId("plantF4Id")._searchField.setVisible(false);this.PlantF4Frag.open()},handlePlantClose:function(e){var t=e.getParameter("selectedItem").getProperty("title");this.desc=e.getParameter("selectedItem").getProperty("description");this.filterModel.getData().Werks=t;this.filterModel.refresh("true");this.PlantF4Frag.destroy();this.PlantF4Frag=""},handlePlantCancel:function(){this.PlantF4Frag.destroy();this.PlantF4Frag=""},onFilterSubmit:function(){var e=this;var t=this.filterModel.getData();this.AddressCodeASNSA=sessionStorage.getItem("AddressCodeASNSA");var s=t.ASNNumber;var a=t.StartDate;var i=t.EndDate;this.fUnitCode=t.Werks;var o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"ddMMMyyyy"});if(i===""&&i===null&&i===undefined){i=new Date}if(a===""&&a===null&&a===undefined){a=new Date(i.getTime()-30*24*3600*1e3)}this.ASNtodate=o.format(i);this.ASNfromdate=o.format(a);this.ASNtodate=this.ASNtodate.substring(0,2)+" "+this.ASNtodate.substring(2,5)+" "+this.ASNtodate.substring(5,9);this.ASNfromdate=this.ASNfromdate.substring(0,2)+" "+this.ASNfromdate.substring(2,5)+" "+this.ASNfromdate.substring(5,9);var d=this.getOwnerComponent().getModel();d.read("/GetASNHeaderList",{urlParameters:{AddressCode:this.AddressCodeASNSA,PoNumber:"",ASNNumber:s||"",ASNFromdate:this.ASNfromdate,ASNTodate:this.ASNtodate,InvoiceStatus:"",MRNStatus:"",ApprovedBy:""},success:function(t){sap.ui.core.BusyIndicator.hide();e.PlantCode=t.results[0].PlantCode;e.ASNStatus=t.results[0].ASNStatus;e.DataModel.setData(t);e.DataModel.refresh();e.data=[...t.results];if(e.fUnitCode){const t=e.data.filter(t=>t.PlantCode===e.fUnitCode);e.DataModel.setData({results:t})}e.routeToDetail()},error:function(e){sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.response.body);r.error(t.error.message.value)}});if(t.Werks){this.PlantFilter=this.fUnitCode+"("+this.desc+")";this.getView().byId("plantFilterId").setText(this.PlantFilter)}this.getView().byId("clearFilterId").setVisible(true);this.filterFragment.close();this.filterFragment.destroy();this.filterFragment="";this.routeToDetail()},onFilterCancel:function(){this.filterFragment.close();this.filterFragment.destroy();this.filterFragment=""},onFilterClear:function(){this.getView().byId("clearFilterId").setVisible(false);this.getView().byId("plantFilterId").setText("");this.getASNData()}})});