sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/export/Spreadsheet"],function(e,t,a){"use strict";return e.extend("sap.fiori.asncreationsa.controller.SAConfirm",{onInit:function(){this.fragModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.fragModel,"fragModel");this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.oDataModel.setRefreshAfterChange(false);this.flagModel=sap.ui.getCore().getModel("flagModel");this.getView().setModel(this.oDataModel);this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.detailModel=new sap.ui.model.json.JSONModel;this.detailModel.setSizeLimit(1e11);this.getView().setModel(this.detailModel,"detailModel");this.headerModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.headerModel,"headerModel");this.popOverModel=new sap.ui.model.json.JSONModel;this.detailAmountPopoverModel=new sap.ui.model.json.JSONModel;this.ConfirmFragModel=new sap.ui.model.json.JSONModel;this.getView().addStyleClass("sapUiSizeCompact")},onNavBack:function(){var e=History.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{this.router.navTo("SAMaster")}},handleRouteMatched:function(e){if(e.getParameter("name")==="SAConfirm"){var a=this;this.getView().byId("DeliveryTableId").removeSelections(true);this.Schedule_No=e.getParameter("arguments").Schedule_No;var r="/S_HEADERSet(Schedule_No='"+this.Schedule_No+"')";this.oDataModel.read(r,null,null,false,function(e){sap.ui.core.BusyIndicator.hide();a.odata=e;a.headerModel.setData(e);a.headerModel.refresh(true)},function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.response.body);t.error(a.error.message.value)});sap.ui.core.BusyIndicator.show(0);this.oDataModel.read("/ConfirmDataSet?$filter=Schedule_No eq '"+this.Schedule_No+"'",null,null,false,function(e){sap.ui.core.BusyIndicator.hide();a.odata=e;a.detailModel.setData(e);a.detailModel.refresh(true)},function(e){sap.ui.core.BusyIndicator.hide();var r=JSON.parse(e.response.body);t.error(r.error.message.value);a.router.navTo("SADetail",{Schedule_No:a.Schedule_No})})}},dateFormat:function(e){if(e!==""&&e!==null&&e!==undefined){var t=e.substring(4,6)+"/"+e.substring(6,8)+"/"+e.substring(0,4);var a=new Date(t);var r=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd MMM"});return r.format(a)}return""},onCofirmAsn:function(e){var a=this;this.detailModel.refresh(true);this.data=this.headerModel.getData();this.tableData=this.detailModel.getData().results;var r=this.getView().byId("DeliveryTableId");var i=r.getSelectedContexts();if(i.length){var o={Amount:this.data.Amount,Buyer_Name:this.data.Buyer_Name,Currency:this.data.Currency,Item_Count:this.data.Item_Count,Order_Type:this.data.Order_Type,Order_Type_Desc:this.data.Order_Type_Desc,Schedule_Date:this.data.Schedule_Date,Schedule_No:this.data.Schedule_No,Purchase_Group:this.data.Purchase_Group,Purchase_Group_Desc:this.data.Purchase_Group_Desc,Purchase_Org:this.data.Purchase_Org,Purchase_Org_Desc:this.data.Purchase_Org_Desc,Status:this.data.Status,Upcoming_Del_Date:this.data.Upcoming_Del_Date,Vendor_Name:this.data.Vendor_Name,Confirmnav:[]};var s=i.map(function(e){return e.getObject()});if(s.length){for(var n=0;n<s.length;n++){var l=parseFloat(s[n].Quantity);if(l===0){sap.m.MessageBox.error("Quantity can't be Zero");sap.ui.core.BusyIndicator.hide();return}if(l<0||s[n].Quantity.includes("-")){sap.m.MessageBox.error("Quantity can't be in negative.");sap.ui.core.BusyIndicator.hide();return}if(s[n].Quantity&&s[n].Date){var d=new Date(s[n].ReqDate.substring(0,4)+"-"+s[n].ReqDate.substring(4,6)+"-"+s[n].ReqDate.substring(6,8));d=d.setHours(0,0,0,0);var u=new Date(s[n].ShipDate.substring(0,4)+"-"+s[n].ShipDate.substring(4,6)+"-"+s[n].ShipDate.substring(6,8));u=u.setHours(0,0,0,0);var h=new Date;h=h.setHours(0,0,0,0);if(u<h){t.error("Please enter current date or future date");sap.ui.core.BusyIndicator.hide();return}if(d<h){if(parseInt(s[n].Quantity)<=parseInt(s[n].Po_Qty)-parseInt(s[n].Con_Qty)){o.Confirmnav.push(s[n])}else{t.error("Quantity to be confirmed is greater than the balance quantity for "+s[n].Material_Desc);sap.ui.core.BusyIndicator.hide();return}}else{if(parseInt(s[n].Quantity)<=parseInt(s[n].Po_Qty)-parseInt(s[n].Con_Qty)){o.Confirmnav.push(s[n])}else{t.error("Quantity to be confirmed is greater than the balance quantity for "+s[n].Material_Desc);sap.ui.core.BusyIndicator.hide();return}}}else{t.error("Quantity and Confirmation date is required for selected items");sap.ui.core.BusyIndicator.hide();return}}}}if(o.Confirmnav.length<=0){t.error("No Items Selected")}else{t.confirm("Do You Want to Confirm ? ",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CLOSE],onClose:function(e){if(e==="OK"){sap.ui.core.BusyIndicator.show(0);a.oDataModel.create("/S_HEADERSet",o,null,function(e){t.confirm("Successfully Confirmed!",{icon:sap.m.MessageBox.Icon.SUCCESS,title:"SUCCESS",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){sap.ui.core.BusyIndicator.hide();a.oDataModel.read("/ConfirmDataSet?$filter=Schedule_No eq '"+this.Schedule_No+"'",null,null,false,function(e){sap.ui.core.BusyIndicator.hide();r.removeSelections();a.odata=e;a.detailModel.setData(e);a.detailModel.refresh(true)},function(e){sap.ui.core.BusyIndicator.hide();var r=JSON.parse(e.response.body);t.error(r.error.message.value);a.router.navTo("SADetail",{Schedule_No:a.Schedule_No})})}})},function(e){sap.ui.core.BusyIndicator.hide();a.router.navTo("SADetail",{Schedule_No:a.Schedule_No})})}}})}},onFragClose:function(e){e.getSource().getParent().close()},onQuanPress:function(e){var t=this;if(!this.QuantFrag){this.QuantFrag=sap.ui.xmlfragment("sap.fiori.asncreationsa.view.SAFragRequiredQuan",this);this.getView().addDependent(this.QuantFrag)}var a=e.getSource().getBindingContext("detailModel").getPath();var r=this.detailModel.getProperty(a);this.oDataModel.read("/S_LINEITEMSSet?$filter=Schedule_No eq '"+r.Schedule_No+"' and Schedule_Item eq '"+r.Schedule_Item+"' and Material_No eq '"+r.Material_No+"' and Uom eq '"+r.Uom+"'",null,null,false,function(e,a){t.popOverModel.setData(e);t.QuantFrag.setModel(t.popOverModel,"itemModel");t.popOverModel.refresh(true)});this.QuantFrag.openBy(e.getSource())},onQtyLiveChange:function(e){if(e.getParameter("newValue").includes(".")){t.error("Fractional Values are not allowed");e.getSource().setValue(parseInt(e.getParameter("newValue"),10).toString());return}},onTableFinished:function(e){var t=this.getView().byId("DeliveryTableId").getItems();for(var a=0;a<t.length;a++){var r=t[a]}},onDateChanged:function(e){var t=e.getSource();t.$().find("INPUT").attr("disabled",true).css("color","#000000")},onDateFilter:function(e){var a=this.byId("FromDateId").getValue();var r=this.byId("ToDateId").getValue();var i=this.getView().byId("DeliveryTableId").getBinding("items");if(a||r){var o=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter({path:"ShipDate",operator:sap.ui.model.FilterOperator.LE,value1:r}),new sap.ui.model.Filter({path:"ShipDate",operator:sap.ui.model.FilterOperator.GE,value1:a})],and:true});i.filter(o)}else{t.error("No Dates are Selected")}},onDateFilterClear:function(e){this.byId("FromDateId").setValue("");this.byId("ToDateId").setValue("");this.getView().byId("DeliveryTableId").getBinding("items").filter([])},onMaterialLiveChange:function(e){var t=e.getParameter("newValue")||e.getParameter("query")||"";var a=[];if(t){a.push(new sap.ui.model.Filter("Material_No",sap.ui.model.FilterOperator.Contains,t));a.push(new sap.ui.model.Filter("Material_Desc",sap.ui.model.FilterOperator.Contains,t))}else{a.push(new sap.ui.model.Filter("Material_No",sap.ui.model.FilterOperator.EQ,""));a.push(new sap.ui.model.Filter("Material_Desc",sap.ui.model.FilterOperator.Contains,""))}this.byId("DeliveryTableId").getBinding("items").filter(new sap.ui.model.Filter({filters:a}))},onRowSelect:function(e){var t=this.detailModel.getData();var a=this.getView().byId("DeliveryTableId");var r=a.getSelectedContexts();for(var i=0;i<r.length;i++){var o=r[i].getPath().substring(r[i].getPath().lastIndexOf("/")+1);var s=r[i].getProperty();for(var n=0;n<a.getItems().length;n++){var l=a.getItems()[n].getBindingContext("detailModel").getProperty();var d=a.getItems()[n].getBindingContext("detailModel").getPath().substring(a.getItems()[n].getBindingContext("detailModel").getPath().lastIndexOf("/")+1);if(l.Material_No===s.Material_No&&l.Schedule_Item===s.Schedule_Item&&parseInt(d)<parseInt(o)&&!a.getItems()[n].getSelected()){var u=a.getItems()[n+1].getBindingContext("detailModel").getProperty();if(u.Material_No===s.Material_No&&u.Schedule_Item===s.Schedule_Item){a.getItems()[n+1].setSelected(false)}}}}},onExportPress:function(){var e=this.getView().getModel("detailModel").getData().results;this.filename="Data.xlsx";if(e.length>0){let t=[],r,i,o="{0}";const s=this.byId("DeliveryTableId").getItems()[0];this.byId("DeliveryTableId").getColumns().forEach((e,a)=>{if(e.getAggregation("header")){r=s.getAggregation("cells")[a];switch(r.getMetadata().getName()){case"sap.m.ObjectIdentifier":i=[r.getBindingInfo("title").parts[0].path];o="{0}";break;case"sap.m.ObjectNumber":i=r.getBindingInfo("number").parts[0].path;break;case"sap.m.Input":i=r.getBindingInfo("value").parts[0].path;break;case"sap.m.DatePicker":i=r.getBindingInfo("value").parts[0].path;break;case"sap.m.Button":break;default:i=r.getBindingInfo("text").parts[0].path;break}t.push({label:e.getAggregation("header").getText(),property:i,template:o})}});const n=new a({workbook:{columns:t},dataSource:e,fileName:this.filename});n.build().finally(()=>n.destroy())}else MessageToast.show("No data to export")}})});