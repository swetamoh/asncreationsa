sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,s,o,a){"use strict";return e.extend("sap.fiori.asncreationsa.controller.SADetail",{onInit:function(){this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.getView().setModel(this.oDataModel);this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.detailModel=new sap.ui.model.json.JSONModel;this.detailModel.setSizeLimit(1e7);this.getView().setModel(this.detailModel,"detailModel");this.getView().setModel(new s({}),"DecisionModel");this.getView().addStyleClass("sapUiSizeCompact");this.byId("uploadSet").attachEvent("openPressed",this.onOpenPressed,this)},handleRouteMatched:function(e){if(e.getParameter("name")==="SADetail"){sap.ui.core.BusyIndicator.show();this.odata={};var s=this;var o=this.getOwnerComponent().getModel();this.LoggedUser=sessionStorage.getItem("LoggedUser")||"rajeshsehgal@impauto.com";var a=e.getParameter("arguments");this.AsnNumber=a.AsnNumber.replace(/-/g,"/");this.AsnNum=a.AsnNumber;this.UnitCode=a.UnitCode;this.AddressCode=a.AddressCode;this.ASNStatus=a.ASNStatus;var i=this.byId("uploadSet");i.removeAllItems();s.detailModel.setData([]);s.detailModel.refresh();o.read("/GetASNDetailList",{urlParameters:{username:this.LoggedUser,AddressCode:this.AddressCode,ASNNumber:this.AsnNumber,UnitCode:this.UnitCode},success:function(e){sap.ui.core.BusyIndicator.hide();s.detailModel.setData(e);s.detailModel.getData().ASNStatus=s.ASNStatus;s.detailModel.refresh();s._fetchFilesForPoNum(s.AsnNum)},error:function(e){sap.ui.core.BusyIndicator.hide();var s=JSON.parse(e.response.body);t.error(s.error.message.value)}})}},_fetchFilesForPoNum:function(e){var t=this.getView().getModel("catalog");var s=this.byId("uploadSet");s.removeAllItems();t.read("/Files",{filters:[new sap.ui.model.Filter("AsnNum",sap.ui.model.FilterOperator.EQ,e)],success:function(e){e.results.forEach(function(e){var t=new sap.m.upload.UploadSetItem({fileName:e.fileName,mediaType:e.mediaType,url:e.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:e.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:e.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:e.size.toString()})]});s.addItem(t)})},error:function(e){console.log("Error: "+e)}})},onOpenPressed:function(e){e.preventDefault();var t=e.getParameter("item");this._fileName=t.getFileName();this._download(t).then(e=>{var t=window.URL.createObjectURL(e);var s=document.createElement("a");s.href=t;s.setAttribute("download",this._fileName);document.body.appendChild(s);s.click();document.body.removeChild(s)}).catch(e=>{console.log(e)})},_download:function(e){console.log("_download");var t={url:e.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((e,s)=>{$.ajax(t).done((t,s,o)=>{e(t)}).fail(e=>{s(e)})})},onCancelAsn:function(e){this.getView().getModel("DecisionModel").setData({});const t=sap.ui.xmlfragment("sap.fiori.asncreationsa.fragment.Remarks",this);this.getView().addDependent(t);t.open()},onSubmit:function(e){this.dialogSource=e.getSource();const s=this.getView().getModel("DecisionModel").getData();if(s.Reason!==""){this.Reason=s.Reason;this.onFinalCancelAsn()}else{t.error("Please fill reason to proceed")}},onDialogClose:function(e){e.getSource().destroy()},onDialogCancel:function(e){e.getSource().getParent().destroy()},onFinalCancelAsn:function(){sap.ui.core.BusyIndicator.show();var e=this;var s={UnitCode:this.UnitCode,OprCode:this.AddressCode,ASNNumber:this.AsnNumber,Reason:this.Reason,CreatedBy:this.LoggedUser,CreatedIP:""};var o=JSON.stringify(s);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.asncreationsa")}var a=this.hardcodedURL+`/asnsa/odata/v4/catalog/PostASNCancellation`;$.ajax({type:"POST",headers:{"Content-Type":"application/json"},url:a,data:JSON.stringify({asnData:o}),context:this,success:function(s,o,a){e.dialogSource.getParent().destroy();sap.ui.core.BusyIndicator.hide();e.AsnNum=s.d.PostASNCancellation;t.success(e.AsnNum+" ASN cancelled succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(t){if(t==="OK"){e.getData()}}})}.bind(this),error:function(s){sap.ui.core.BusyIndicator.hide();e.dialogSource.getParent().destroy();var o=JSON.parse(s.responseText);t.error(o.error.message.value)}})},getData:function(){sap.ui.core.BusyIndicator.show();var e=this;var s=this.getOwnerComponent().getModel();e.detailModel.setData([]);e.detailModel.refresh();s.read("/GetASNDetailList",{urlParameters:{username:this.LoggedUser,AddressCode:this.AddressCode,ASNNumber:this.AsnNumber,UnitCode:this.UnitCode},success:function(t){sap.ui.core.BusyIndicator.hide();e.detailModel.setData(t);e.detailModel.refresh();e._fetchFilesForPoNum(e.AsnNum)},error:function(e){sap.ui.core.BusyIndicator.hide();var s=JSON.parse(e.response.body);t.error(s.error.message.value)}})}})});